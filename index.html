<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="dist/style.css">
    <link rel="stylesheet" href="./style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Pointerize is suited to almost any task that involves shapes (SVG)">
    <meta name="author" content="Abolfazl Faturechi">
    <meta name="keywords" content="shape, svg, pattern, cursor, mouse, background, icon, javascript">
    <title>Pointerize</title>
  </head>
  <body>

    <div id="app">
      <header>
        <h1>Pointerize</h1>
      </header>
      <main>
        <div class="text__s links">
          <a href="docs/index.html">API</a>
          <a href="https://github.com/ize-er/pointerize">Github</a>
        </div>
        <section>
          <p class="text__l">If only there was a way we could easily ...</p>
          <div id="introduction">
            <div class="introduction_nth">
              <div class="introduction_nth__text">
                <h2 class="text__m">Create shapes like this</h2>
              </div>
              <div id="introduction_0th__svg" class="introduction_nth__svg"></div>
            </div>
            <div class="introduction_nth">
              <div class="introduction_nth__text">
                <h2 class="text__m">And turn them into icons, patterns and custom cursors</h2>
              </div>
            </div>
          </div>
        </section>
        <section>

          <button id="show_config" class="text__l">If only ...</button>
          <div id="config_container">
            <div id="config" aria-label="config">
              <button id="hide_config" class="text__s">hide configuration</button>
              <div id="config__options">
                <button id="toggle_pointer" class="text__s">remove custom pointer</button>
                <h3 class="text__m">Shapes</h3>
              </div>
              <button id="apply_options" class="text__m">Apply</button>
              <hr>
              <h3 class="text__m">Generated options</h3>
              <div id="code_out">
                <details>
                  <summary>shapes</summary>
                  <code id="options_out__shapes" class="text__s"></code>
                </details>
                <details>
                  <summary>image</summary>
                  <code id="options_out__image" class="text__s"></code>
                </details>
                <details>
                  <summary>background pattern</summary>
                  <code id="options_out__pattern" class="text__s"></code>
                </details>
                <details>
                  <summary>pointer (cursor)</summary>
                  <code id="options_out__pointer" class="text__s"></code>
                </details>
              </div>
            </div>
          </div>
          
        </section>
        <section id="preset">
          <div class="select_con">
            <select name="presets" id="presets" class="text__l">
              <option value="basic_1">preset - basic 1</option>
              <option value="basic_2">preset - basic 2</option>
              <!-- <option value="basic_3">basic 3</option> -->
              <option value="advanced_1">preset - advanced 1</option>
              <option value="advanced_2">preset - advanced 2</option>
              <option value="advanced_3">preset - advanced 3</option>
              <option value="advanced_4">preset - advanced 4</option>
              <option value="advanced_5" selected>preset - advanced 5</option>
            </select>
          </div>
          
          <div id="preset__svg"></div>
        </section>
        <section class="text__s" id="notes">
          <p>To use the options generated on this page you should change css selectors and maybe css properties to make it suited to your own page.</p>
          <p>There are more options that you can tweak. See the docs and the above presets' code on Github.</p>
          <div class="links text__m">
            <a href="docs/index.html">API</a>
            <a href="https://github.com/ize-er/pointerize">Github</a>
          </div>
        </section>
      </main>
    </div>
    
    <script type="module">

      import Pointerize from './dist/pointerize.js'
      import {
        presetBasic1,
        presetBasic2,
        // presetBasic3, // it's a custom pointer and not really necessary, we already have one 
        presetAdvanced1,
        presetAdvanced2,
        presetAdvanced3,
        presetAdvanced4,
        presetAdvanced5,
      } from './dist__site/presets.js'
      import tokens from './dist__site/tokens.js'


      const { color_brand_1_2,
              color_brand_2_2,
              color_gray_2 } = { ...tokens.colors}
      
      // the default values

      const defaults = {
        shape: {
          type: 'circle',
          sides: 8,
          ratios: {
            size: 1,
            radius: 0.6
          }
        },
        shapesNum: 4,
        slider: {
          sides: {
            min: '0',
            max: '16'
          },
          ratio: {
            radius: {
              min: '0',
              max: '20'
            },
            size: {
              min: '0',
              max: '20'
            }
          }
        }
      }
      
      // default shapes

      const shapeCircle = {
        type: 'circle',
        svg_attributes: {
          stroke: color_gray_2
        }
      }
      const shapePolygon = {
        type: 'polygon',
        sides: defaults.shape.sides,
        svg_attributes: {
          stroke: color_gray_2
        },
        ratios: [
          {
            type: 'radius',
            options: {
              value: defaults.shape.ratios.radius
            }
          }
        ]
      }

      // initial shapes
      let shapes = [
        {
          type: 'polygon',
          sides: 4,
          svg_attributes: {
            stroke: color_gray_2
          },
          guides: [
            {
              type: 'position',
              options: {
                shapes: [
                  {
                    type: 'circle',
                    svg_attributes: {
                      stroke: color_gray_2
                    }
                  },
                  {
                    type: 'circle',
                    svg_attributes: {
                      stroke: color_gray_2
                    }
                  },
                  {
                    type: 'circle',
                    svg_attributes: {
                      stroke: color_gray_2
                    }
                  },
                  {
                    type: 'circle',
                    svg_attributes: {
                      stroke: color_gray_2
                    }
                  }
                ]
              }
            }
          ]
        }
      ]

      //0 global data
      //1 used for determining index of shapes arrays, id attributes, etc.
      const shapesNth = {
        depth0: -1
      }

      // makes a unique(kindof) id to be used for id attributes
      const makeUuid = () => {
        return Date.now().toString(32) + Math.random().toString(16).substring(2)
      }

      function makeInputShapeSides(depth, nth, shapeObj) {

        const uuid = makeUuid()
        const inputContainer = document.createElement('div')
        inputContainer.classList.add('text__s')
        inputContainer.classList.add('input_container')
        const label = document.createElement('label')
        label.for = `dpth${depth}__shape_sides_${nth}th__${uuid}`
        const input = document.createElement('input')
        input.type = 'range'
        input.min = defaults.slider.sides.min
        input.max = defaults.slider.sides.max
        input.id = `dpth${depth}__shape_sides_${nth}th__${uuid}`
        const out = document.createElement('span')
        out.id = `dpth${depth}__shape_sides_${nth}th__out__${uuid}`
        input.value = out.textContent = `${defaults.shape.sides}`

        input.addEventListener('input', (e) => {
          const shapeSides = e.target.value
          shapeObj.sides = +shapeSides
          out.textContent = shapeSides
        })

        label.textContent = 'sides'
        inputContainer.appendChild(label)
        inputContainer.appendChild(input)
        inputContainer.appendChild(out)
        return inputContainer
      }
      
      function makeInputGuidePos(depth, nth, shapeObj, parentShapeContainer) {

        const uuid = makeUuid()
        const inputContainer = document.createElement('div')
        inputContainer.classList.add('text__s')
        inputContainer.classList.add('input_container')
        const label = document.createElement('label')
        label.for = `dpth${depth}__guide_pos_${nth}th__${uuid}`
        const input = document.createElement('input')
        input.type = 'checkbox'
        input.id = `dpth${depth}__guide_pos_${nth}th__${uuid}`
        input.checked = false
        const elPosShapesContainer = document.createElement('div')

        input.addEventListener('change', (e) => {
          if (e.target.checked === true) {
            
            depth++
            shapesNth[`depth${depth}`] = 0
            shapeObj.guides = [
              {
                type: 'position',
                options: {
                  shapes: []
                }
              }
            ]
            shapeObj.guides[0].options.shapes.push(JSON.parse(JSON.stringify(shapeCircle)))
            elPosShapesContainer.classList.add('config__options__shape__pos')
            const elShapeType = makeInputShapeType(depth, 0, shapeObj.guides[0].options.shapes, {el: elPosShapesContainer, shape: shapeObj })
            elPosShapesContainer.insertAdjacentElement('afterbegin', elShapeType)
            parentShapeContainer.appendChild(elPosShapesContainer)
          }
          else {
            delete shapeObj.guides
            elPosShapesContainer.replaceChildren()
            elPosShapesContainer.remove()
          }
        })

        label.textContent = 'position guide'
        inputContainer.appendChild(label)
        inputContainer.appendChild(input)
        return inputContainer
      }

      const shapeTypes = ['polygon', 'circle']
      function makeInputShapeType(depth, nth, shapesArray, posGuideData = undefined) {
        
        let shapeObj = shapesArray[nth]
        const uuid = makeUuid()
        const shapeContainer = document.createElement('div')
        shapeContainer.classList.add('config__options__shape')
        const selectContainer = document.createElement('div')
        const select = document.createElement('select')
        select.name = select.id = `dpth${depth}__shape_type_${nth}th__${uuid}`
        select.classList.add('text__m')
        for (const t of shapeTypes) {
          const option = document.createElement('option')
          option.value = option.textContent = t
          if (t === shapeObj.type) {
            option.selected = true
          }
          select.appendChild(option)
        }

        //0 button to remove shape
        const elRemove = document.createElement('button')
        elRemove.textContent= '-'
        elRemove.classList.add('remove_shape')
        elRemove.classList.add('text__m')
        //1 if it's the first and only shape, disable the remove button
        if (nth === 0) {
          elRemove.setAttribute('disabled', 'disabled')
        }
        //1
        elRemove.addEventListener('click', (e) => {

          /* 
            `nth` only shows the initial order which can change when the user removes from the middle so
            find the actual index that the object belongs to first and use that to change the array.
            The same process is used further down for select.
          */
          const nthActual = shapesArray.findIndex((obj) => Object.is(obj, shapeObj))
          shapesArray.splice(nthActual, 1)
          shapesNth[`depth${depth}`]--

          //0 keep a reference to parent element for future use
          const elParent = shapeContainer.parentElement
        
          //0 remove everything
          shapeContainer.replaceChildren()
          shapeContainer.remove()
          
          //0 enable and disable buttons
          //1 if the add button was previously disabled (because the number of shapes equalled the positoin guide's sides), enable it now
          const elAdd = elParent.querySelector('button.add_shape')
          if (elAdd.hasAttribute('disabled')) {
            elAdd.removeAttribute('disabled')
          }
          //1 if the number of shapes equals 1, disable the remove button
          const shapesNumber = elParent.querySelectorAll('.config__options__shape').length
          if (shapesNumber === 1) {
            elParent.querySelector('div.config__options__shape > button.remove_shape').setAttribute('disabled', 'disabled')
          }
          
        })
        // button to add shape if there's position guide
        if (posGuideData !== undefined) {
          const elAdd = document.createElement('button')
          elAdd.classList.add('add_shape')
          elAdd.classList.add('text__m')
          elAdd.textContent = '+'
          elAdd.addEventListener('click', (e) => {
            shapesNth[`depth${depth}`]++
            shapesArray.push(JSON.parse(JSON.stringify(shapeCircle)))
            const el = makeInputShapeType(depth, shapesNth[`depth${depth}`], shapesArray)
            elAdd.insertAdjacentElement('beforebegin', el)
            // if shapes number equals the position guide's sides, disable the add button
            const shapesNumber = posGuideData.el.querySelectorAll('div.config__options__shape').length
            if (posGuideData.shape.sides === shapesNumber) {
              elAdd.setAttribute('disabled', 'disabled')
            }
            // if the only shape's remove button is disabled, enable it
            const elRemovePos = posGuideData.el.querySelector('div.config__options__shape > button.remove_shape')
            if (elRemovePos.hasAttribute('disabled')) {
              elRemovePos.removeAttribute('disabled')
            }
          })
          posGuideData.el.appendChild(elAdd)
        }

        select.addEventListener('change', (e) => {
          
          const shapeType = e.target.value
          if (shapeType === 'polygon') {

            // initial values for polygon
            const nthActual = shapesArray.findIndex((obj) => Object.is(obj, shapeObj))
            shapeObj = JSON.parse(JSON.stringify(shapePolygon))
            shapesArray[nthActual] = shapeObj

            // remove circle-related inputs
            const inputs = Array.from(shapeContainer.querySelectorAll('.input_container'))
            for (const i of inputs) {
              i.replaceChildren()
              i.remove()
            }

            // add polygon-related inputs
            const elSides = makeInputShapeSides(depth, nth, shapeObj)
            const elGuidePos = makeInputGuidePos(depth, nth, shapeObj, shapeContainer)
            const elRatioRadius = makeInputShapeRatioRadius(nth, shapeObj)
            const elRatioSize = makeInputShapeRatioSize(nth, shapeObj)
            const elHr = document.createElement('hr')
            
            elRemove.insertAdjacentElement('beforebegin', elSides)
            elRemove.insertAdjacentElement('beforebegin', elRatioSize)
            elRemove.insertAdjacentElement('beforebegin', elRatioRadius)
            elRemove.insertAdjacentElement('afterend', elGuidePos)
            elRemove.insertAdjacentElement('afterend', elHr)
          }
          else {

            // initial values for circle
            const nthActual = shapesArray.findIndex((obj) => Object.is(obj, shapeObj))
            shapeObj = JSON.parse(JSON.stringify(shapeCircle))
            shapesArray[nthActual] = shapeObj
            
            // remove polygon-related inputs
            const inputs = Array.from(shapeContainer.querySelectorAll('.input_container'))
            for (const i of inputs) {
              i.replaceChildren()
              i.remove()
            }
            const elHr = shapeContainer.querySelector('hr')
            elHr.remove()

            // add circle-related inputs
            const elRatioSize = makeInputShapeRatioSize(nth, shapeObj)
            elRemove.insertAdjacentElement('beforebegin', elRatioSize)
          }
        })

        selectContainer.appendChild(select)
        shapeContainer.appendChild(selectContainer)
        shapeContainer.appendChild(elRemove)
        if (shapeObj.type === 'polygon') {

          // add polygon-related inputs
          const elSides = makeInputShapeSides(depth, nth, shapeObj)
          const elGuidePos = makeInputGuidePos(depth, nth, shapeObj, shapeContainer)
          const elRatioRadius = makeInputShapeRatioRadius(nth, shapeObj)
          const elRatioSize = makeInputShapeRatioSize(nth, shapeObj)
          const elHr = document.createElement('hr')

          elRemove.insertAdjacentElement('beforebegin', elSides)
          elRemove.insertAdjacentElement('beforebegin', elRatioSize)
          elRemove.insertAdjacentElement('beforebegin', elRatioRadius)
          elRemove.insertAdjacentElement('afterend', elGuidePos)
          elRemove.insertAdjacentElement('afterend', elHr)
        }
        else {

          // add circle-related inputs
          const elRatioSize = makeInputShapeRatioSize(nth, shapeObj)
          elRemove.insertAdjacentElement('beforebegin', elRatioSize)
        }

        return shapeContainer
      }
      
      function makeInputShapeRatioSize(nth, shapeObj) {

        const uuid = makeUuid()
        const inputContainer = document.createElement('div')
        inputContainer.classList.add('text__s')
        inputContainer.classList.add('input_container')
        const label = document.createElement('label')
        label.for = `shape_${nth}th__ratio__size__${uuid}`
        const input = document.createElement('input')
        input.type = 'range'
        input.min = defaults.slider.ratio.size.min
        input.max = defaults.slider.ratio.size.max
        input.id = `shape_${nth}th__ratio__size__${uuid}`
        const out = document.createElement('span')
        out.id = `shape_${nth}th__out__ratio__size__${uuid}`
        input.value = `${defaults.shape.ratios.size * 10}`
        out.textContent = `${defaults.shape.ratios.size}`

        input.addEventListener('input', (e) => {

          const ratioSize = e.target.value / 10
          if (!shapeObj.ratios?.length) {
            shapeObj.ratios = [{type: 'size', options: {value: ratioSize}}]
          }
          else {
            let index = -1
            for (const r of shapeObj.ratios) {
              index++
              if (r.type === 'size') {
                r.options.value = ratioSize
                break
              }
              else if (index === shapeObj.ratios.length - 1) {
                shapeObj.ratios.push({type: 'size', options: {value: ratioSize}})
              }
            }
          }
          out.textContent = ratioSize
        })

        label.textContent = 'size ratio'
        inputContainer.appendChild(label)
        inputContainer.appendChild(input)
        inputContainer.appendChild(out)
        return inputContainer
      }

      function makeInputShapeRatioRadius(nth, shapeObj) {

        const uuid = makeUuid()
        const inputContainer = document.createElement('div')
        inputContainer.classList.add('text__s')
        inputContainer.classList.add('input_container')
        const label = document.createElement('label')
        label.for = `shape_${nth}th__ratio__radius__${uuid}`
        const input = document.createElement('input')
        input.type = 'range'
        input.min = defaults.slider.ratio.radius.min
        input.max = defaults.slider.ratio.radius.max
        input.id = `shape_${nth}th__ratio__radius__${uuid}`
        const out = document.createElement('span')
        out.id = `shape_${nth}th__out__ratio__radius__${uuid}`
        input.value = `${defaults.shape.ratios.radius * 10}`
        out.textContent = `${defaults.shape.ratios.radius}`

        input.addEventListener('input', (e) => {
          const ratioRadius = e.target.value / 10
          if (!shapeObj.ratios?.length) {
            shapeObj.ratios = [{type: 'radius', options: {value: ratioRadius}}]
          }
          else {
            let index = -1
            for (const r of shapeObj.ratios) {
              index++
              if (r.type === 'radius') {
                r.options.value = ratioRadius
                break
              }
              else if (index === shapeObj.ratios.length - 1) {
                shapeObj.ratios.push({type: 'radius', options: {value: ratioRadius}})
              }
            }
          }
          out.textContent = ratioRadius
        })
          
        label.textContent = 'radius ratio'
        inputContainer.appendChild(label)
        inputContainer.appendChild(input)
        inputContainer.appendChild(out)
        return inputContainer
      }
      
      // pattern
      let pointerize0th
      function pattern() {

        const patternTarget = {
          type: 'square',
          svg_attributes: {
            'stroke-width': '0',
          },
          guides: [
            {
              type: 'pattern',
              options: {
                area: 'fill',
                ratios: {
                  tile: 0.05,
                  gap: {
                    row: 0.01,
                    column: 0.01
                  }
                },
                shapes: JSON.parse(JSON.stringify(shapes))
              },
            },
          ],
        }

        let options0th = {
          element__svg: {
            svg_attributes: {
              preserveAspectRatio: 'xMidYMid slice',
            },
          },
          element__svg_container: {
            css_properties: {
              position: 'fixed',
              top: '0px',
              left: '0px',
              width: '100%',
              height: '100%',
              'z-index': '-1'
            },
          },
          shapes: [patternTarget],
        }

        pointerize0th = new Pointerize(options0th)
        pointerize0th.start()
        return options0th
      }
      let optionsPattern = pattern()

      // pointer
      let pointerize1th
      function pointer() {
         
        const shapesPointer = [
          ...JSON.parse(JSON.stringify(shapes)),
          {
            type: 'circle',
            svg_attributes: {
              'stroke-width': '0',
              fill: color_brand_1_2
            },
            ratios: [
              {
                type: 'size',
                options: {
                  value: 0.1
                }
              }
            ]
          }
        ]

        let options1th = {
          element__svg: {
            svg_attributes: {
              preserveAspectRatio: 'xMidYMid slice',
            },
          },
          element__svg_container: {
            css_properties: {
              position: 'fixed',
              top: '-100px',
              left: '-100px',
              width: '100px',
              height: '100px',
              'z-index': '10'
            },
          },
          interactions: [
            {
              type: 'pointer'
            }
          ],
          shapes: shapesPointer ,
        }
        
        pointerize1th = new Pointerize(options1th)
        pointerize1th.start()
        return options1th
      }
      let optionsPointer = pointer()
      
      // introduction
      let pointerize2th
      function introduction() {
        
        const shapesIntro = JSON.parse(JSON.stringify(shapes))
        function changeColor(shapes) {
          for (const s of shapes) {
            s.svg_attributes.stroke = color_brand_1_2
            if (s.guides?.length) {
              for (const g of s.guides) {
                if (g.type === 'position') {
                  changeColor(g.options.shapes)
                }
              }
            }
          }
        }
        changeColor(shapesIntro)

        let options = {
          element__svg_container: {
            css_properties: {
              width: '100%',
              height: '100%'
            }
          },
          css_selector__root: '#introduction_0th__svg',
          shapes: shapesIntro
        }

        pointerize2th = new Pointerize(options)
        pointerize2th.start()
        return options
      }
      let optionsIntro0 = introduction()

      //0 elements
      const elConfigOpts = document.querySelector('#config__options')
      const elApply = document.querySelector('#apply_options')
      const elOptionsOutShapes = document.querySelector('#options_out__shapes')
      const elOptionsOutImage = document.querySelector('#options_out__image')
      const elOptionsOutPattern = document.querySelector('#options_out__pattern')
      const elOptionsOutPointer = document.querySelector('#options_out__pointer')
      const elConfigContainer = document.querySelector('#config_container')
      const elOpenConfig = document.querySelector('#show_config')
      const elCloseConfig = document.querySelector('#hide_config')
      const elTogglePointer = document.querySelector('#toggle_pointer')
      
      //0 initial
      //1 show user the initial options
      elOptionsOutShapes.textContent = JSON.stringify(shapes)
      elOptionsOutImage.textContent = JSON.stringify(optionsIntro0)
      elOptionsOutPattern.textContent = JSON.stringify(optionsPattern)
      elOptionsOutPointer.textContent = JSON.stringify(optionsPointer)
      //1 assign a simple shape to shapes
      shapes = [JSON.parse(JSON.stringify(shapeCircle))]
      //1 make the initial shape-related config elements
      shapesNth.depth0++
      const el = makeInputShapeType(0, shapesNth.depth0, shapes)
      elConfigOpts.appendChild(el)
      const elAdd = document.createElement('button')
      elAdd.classList.add('add_shape')
      elAdd.classList.add('text__m')
      elAdd.textContent = '+'
      elAdd.addEventListener('click', (e) => {
        shapesNth.depth0++
        shapes.push(JSON.parse(JSON.stringify(shapeCircle)))
        const el = makeInputShapeType(0, shapesNth.depth0, shapes)
        elAdd.insertAdjacentElement('beforebegin', el)
        // if it's not the fisrt and only shape, enable the remove button 
        if (shapesNth.depth0 === 1) {
          elConfigOpts.querySelector('.config__options__shape > button.remove_shape').removeAttribute('disabled')
        }
      })
      elConfigOpts.appendChild(elAdd)

      //0 event listeners for general config buttons
      elOpenConfig.addEventListener('click', () => {
        elConfigContainer.style.width = 'clamp(300px, 50%, 50%)'
      })
      elCloseConfig.addEventListener('click', () => {
        elConfigContainer.style.width = '0'
      })
      
      let defaultPointer = false
      elTogglePointer.addEventListener('click', () => {
        
        defaultPointer = !defaultPointer
        if (defaultPointer) {
          elTogglePointer.textContent = 'create custom pointer'
        }
        else {
          elTogglePointer.textContent = 'remove custom pointer'
        }
        
      })

      elApply.addEventListener('click', (e) => {

        if (!defaultPointer) {
          // stop intance
          pointerize1th.stop()
          // start instance
          optionsPointer = pointer()
          // update the options
          elOptionsOutPointer.textContent = JSON.stringify(optionsPointer)
        }
        else {
          pointerize1th.stop()
          elOptionsOutPointer.textContent = ''
        }
        // stop intances
        pointerize0th.stop()
        pointerize2th.stop()
        // start instances
        optionsPattern = pattern()
        optionsIntro0 = introduction()
        // update the options
        elOptionsOutShapes.textContent = JSON.stringify(shapes)
        elOptionsOutImage.textContent = JSON.stringify(optionsIntro0)
        elOptionsOutPattern.textContent = JSON.stringify(optionsPattern)
      })

      //0 presets
      const presetMap = {
        basic_1: presetBasic1,
        basic_2: presetBasic2,
        // basic_3: presetBasic3,
        advanced_1: presetAdvanced1,
        advanced_2: presetAdvanced2,
        advanced_3: presetAdvanced3,
        advanced_4: presetAdvanced4,
        advanced_5: presetAdvanced5
      }
      
      let currentInstance = new Pointerize({
        css_selector__root: '#preset__svg',
        ...presetAdvanced5()
      })
      currentInstance.start()

      document.querySelector('#presets').addEventListener('change', (e) => {
        currentInstance.stop()
        currentInstance = new Pointerize({
          css_selector__root: '#preset__svg',
          ...presetMap[e.target.value]()
        })
        currentInstance.start()
      })

    </script>
  </body>
</html>
